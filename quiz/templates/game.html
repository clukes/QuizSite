{% extends "base_generic.html" %}
{% load staticfiles %}

{% block style %}
<style>
#plist-{{ request.session.username}} {color: lime;}
#scores-{{ request.session.username}} {color: lime;}
#answers-{{ request.session.username}} {color: lime;}
#page-row {
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
  position: relative;
}
</style>
{% endblock %}

{% block content %}
{% if request.session.currentGameCode is None %}
No current game
{% else %}
<div id="current-screen">
  <h1> Game Loading</h1>
  <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
</div>
{% endif %}
{% endblock %}

{% block roomCode %}
{{ request.session.currentGameCode }}
{% endblock %}

{% block playerList %}
<p id="player-list"></p>
{% endblock %}

{% block scripts %}
{% if request.session.currentGameCode is None %}
{% else %}
{{ request.session.currentGameCode|json_script:"room-code" }}
{{ request.session.userID|json_script:"userID"}}
{{ request.session.username|json_script:"username"}}
<script>
  $(document).ready(function() {
      var currentScreen = document.getElementById("current-screen");
      var onRoundStart = false;
      const userID = JSON.parse(document.getElementById('userID').textContent);
      const username = JSON.parse(document.getElementById('username').textContent);
      const roomCode = JSON.parse(document.getElementById('room-code').textContent);

      var protocol = '';
      if (window.location.protocol === 'https:') {
          protocol = 'wss:';
      } else {
          protocol = 'ws:';
      }

      const chatSocket = new WebSocket(
          protocol + '//'
          + window.location.host
          + '/ws/game/'
          + roomCode
          + '/?userID=' + userID
      );

      chatSocket.onopen = function() {
        console.log( 'opened' );
        chatSocket.sendMessage({ command: 'get_current_screen', userID: userID });
        chatSocket.sendMessage({ command: 'get_player_list', gameID: roomCode });
      };

      chatSocket.sendMessage = function(data) {
        try {
          console.log( data );
          chatSocket.send(JSON.stringify(data));
        }
        catch(err) {
          console.log(err.message);
        }
      };

      chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        document.getElementById("player-list").innerHTML = "Not connected";
      };

      function loadQuestion(data) {
        question = data.question;
        console.log(question);
        document.getElementById('question-id').value = question.id;
        document.getElementById('questionNumber').innerHTML = "Question " + question.number;
        document.getElementById('question').innerHTML = question.question;
        if(question.type == 'i') {
          document.getElementById('image').style.display="block";
          document.getElementById('questionImg').src = question.image;
        }
        var form = document.getElementById("form");
        var answers = document.getElementById("answers");
        document.getElementById('correct-answer-display').style.display = "none";
        if(data.marking === false) {
          form.style.display = "block";
          answers.style.display = "none";
          document.getElementById("form").addEventListener('submit', function(event){event.preventDefault();handleForm(event);})
          document.getElementById("set-answer").onclick = handleForm;
          document.getElementById("current-answer").innerHTML = data.answer;
          document.getElementById('id_response').value = "";
          if(data.answer) {
            document.getElementById("current-answer-display").style.display="block";
          }
        }
        else {
          form.style.display = "none";
          document.getElementById("answer-display").innerHTML = "";
          answers.style.display = "block";
        }
      };

      chatSocket.onmessage = function(e) {
        console.log(e)
        const data = JSON.parse(e.data);
        const command = data.command;
        if(onRoundStart && !command.includes("player")) {
          document.getElementById('page-row').style.backgroundImage = "";
          onRoundStart = false;
        }

        if(command === 'gameStart') {
          $("#current-screen").load("{% static 'quiz/gameStart.html' %}");
        }
        else if(command === 'quizStart') {
          if(data.quizTitle) {
            $("#current-screen").load("{% static 'quiz/quizStart.html' %}", function() {
              document.getElementById('quizTitle').innerHTML = data.quizTitle;
              document.getElementById('quizNumber').innerHTML = data.quizNumber;
              document.getElementById('quizDesc').innerHTML = data.quizDesc;
            });
          }
        }
        else if(command === 'quizEnd') {
          if(data.quizTitle) {
            $("#current-screen").load("{% static 'quiz/quizEnd.html' %}", function() {
              document.getElementById('quizTitle').innerHTML = data.quizTitle;
              document.getElementById('quizNumber').innerHTML = data.quizNumber;
              document.getElementById('scores-display').innerHTML = data.scoresHTML;
            });
          }
        }
        else if(command === 'roundStart') {
          if(data.roundTitle) {
            $("#current-screen").load("{% static 'quiz/roundStart.html' %}", function() {
              onRoundStart = true;
              document.getElementById('roundTitle').innerHTML = data.roundTitle;
              document.getElementById('roundNumber').innerHTML = data.roundNumber;
              document.getElementById('roundDesc').innerHTML = data.roundDesc;
              if(data.roundImg) {
                document.getElementById('round-container').style.background = "rgba(0, 0, 0, 0.75)";
                document.getElementById('page-row').style.backgroundImage = "url('" + data.roundImg + "')";
                fadeIn(document.getElementById('page-row'));
              }
              else {
                // document.getElementById('roundImg').style.display = "none";
              }
            });
          }
        }
        else if(command === 'roundEnd') {
          if(data.roundTitle) {
            $("#current-screen").load("{% static 'quiz/roundEnd.html' %}", function() {
              document.getElementById('roundTitle').innerHTML = data.roundTitle;
              document.getElementById('roundNumber').innerHTML = data.roundNumber;
              document.getElementById('scores-display').innerHTML = data.scoresHTML;
            });
          }
        }
        else if (command === 'question') {
          question = data.question
          if(question.id) {
            if(document.getElementById('question-id')) {
              loadQuestion(data);
            }
            else {
              $("#current-screen").load("{% static 'quiz/showQuestion.html' %}", function() {
                loadQuestion(data);
              });
            }
          }
        }
        else if (command === 'answer') {
          answer = data.answer;
          questionID = document.getElementById('question-id').value;
          if(answer.username == username && answer.questionID == questionID) {
            document.getElementById('current-answer').innerHTML = answer.answer;
            if(answer.answer) {
              document.getElementById("current-answer-display").style.display="block";
              document.getElementById('id_response').value = "";
            }
          }
        }
        else if (command === 'showAnswer') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            usernameElem = document.getElementById('answers-' + data.username);
            if(usernameElem === null) {
              document.getElementById('answer-display').innerHTML += data.answerHTML;
            }
            else {
              usernameElem.innerHTML = data.answerHTML;
            }
          }
        }
        else if (command === 'showAllAnswers') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            document.getElementById('answer-display').innerHTML = data.answersHTML;
          }
        }
        else if (command === 'correctAnswer') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            document.getElementById('correct-answer-display').style.display="block";
            document.getElementById('correct-answer').innerHTML = data.answer;
          }
        }
        else if (command === 'playerList') {
          document.getElementById("player-list").innerHTML = data.playerList;
        }
        else if (command === 'playerConnect') {
          if(data.username !== username) {
            document.getElementById("player-list").innerHTML += "<span id='plist-" + data.username + "'>" + data.username + "</span><br>";
          }
        }
        else if (command === 'playerDisconnect') {
          var element = document.getElementById("plist-"+data.username);
          element.parentNode.removeChild(element);
        }
      };

      function handleForm(event) {
        answer = document.getElementById('id_response').value;
        questionID = document.getElementById('question-id').value
        chatSocket.sendMessage({ command: 'set_text_answer', questionID: questionID, gameID: roomCode, userID: userID, answer: answer });
      };

      function fadeIn(element) {
          element.style.opacity = 0;
          var tick = function () {
              element.style.opacity = +element.style.opacity + 0.0075;
              if (+element.style.opacity < 1) {
                  (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16)
              }
          };
          tick();
      }
});

</script>

{% endif %}
{% endblock %}
