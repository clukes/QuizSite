{% extends "base_generic.html" %}
{% load staticfiles %}

{% block style %}
<style>
#plist-{{ request.session.username}} {color: lime;}
#scores-{{ request.session.username}} {color: lime;}
#answers-{{ request.session.username}} {color: lime;}
#page-row {
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
  position: relative;
}
</style>
{% endblock %}

{% block content %}
{% if request.session.currentGameCode is None %}
No current game
{% else %}
<div id="current-screen" style="height:100%;">
  <h1>Game Loading</h1>
  <i class="fa fa-spinner fa-spin fa-3x fa-fw"></i>
</div>
{% endif %}
{% endblock %}

{% block roomCode %}
{{ request.session.currentGameCode }}
{% endblock %}

{% block playerList %}
<p id="player-list"></p>
{% endblock %}

{% block scripts %}
{% if request.session.currentGameCode is None %}
{% else %}
{{ request.session.currentGameCode|json_script:"room-code" }}
{{ request.session.userID|json_script:"userID"}}
{{ request.session.username|json_script:"username"}}

{% load static %}
<script src="{% static 'scripts/timer.js' %}"></script>
<script src="{% static 'scripts/autosize.js' %}"></script>
<script>
  $(document).ready(function() {
      var currentScreen = document.getElementById("current-screen");
      var onRoundStart = false;
      var currentStage = 0;
      const userID = JSON.parse(document.getElementById('userID').textContent);
      const username = JSON.parse(document.getElementById('username').textContent);
      const roomCode = JSON.parse(document.getElementById('room-code').textContent);
      var timeInterval = setInterval(function() {return false;}, 0);

      var protocol = '';
      if (window.location.protocol === 'https:') {
          protocol = 'wss:';
      } else {
          protocol = 'ws:';
      }

      const chatSocket = new WebSocket(
          protocol + '//'
          + window.location.host
          + '/ws/game/'
          + roomCode
          + '/?userID=' + userID
      );

      chatSocket.onopen = function() {
        console.log( 'opened' );
        chatSocket.sendMessage({ command: 'get_current_screen', userID: userID });
        chatSocket.sendMessage({ command: 'get_player_list', gameID: roomCode });
      };

      chatSocket.sendMessage = function(data) {
        try {
          console.log( data );
          chatSocket.send(JSON.stringify(data));
        }
        catch(err) {
          console.log(err.message);
        }
      };

      chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        document.getElementById("player-list").innerHTML = "Not connected";
      };

      function loadQuestion(data) {
        currentStage = 0;
        question = data.question;
        console.log(question);
        document.getElementById('question-id').value = question.id;
        document.getElementById('questionNumber').innerHTML = "Question " + question.number;
        document.getElementById('question').innerHTML = question.question;
        if(question.media_type == 'i') {
          document.getElementById('image').style.display="block";
          document.getElementById('questionImg').src = question.media_url;
        }
        else if(question.media_type == 'v') {
          document.getElementById('video').style.display="block";
          document.getElementById('videoFrame').src = question.media_url;
        }
        else if(question.media_type == 'a') {
          document.getElementById('audio').style.display="block";
          document.getElementById('audio-player').setAttribute('src', question.media_url);
        }
        var form = document.getElementById("form");
        var answers = document.getElementById("answers");
        document.getElementById('correct-answer-display').style.display = "none";
        if(data.marking === false) {
          document.getElementById("current-answer").innerHTML = data.answer;
          var timerEnd = new Date(Date.parse(new Date(data.timerEnd)));
          console.log(timerEnd);
          timeInterval = initializeClock('timerCountdown', timerEnd, data.timeRemaining, timeInterval);
          if(question.multiple_choice_form) {
            document.getElementById('options').innerHTML = question.multiple_choice_form;
            document.getElementById("form").addEventListener('submit', function(event){event.preventDefault();handleMultipleChoiceForm(event);})
            document.getElementById("set-answer").onclick = handleMultipleChoiceForm;
            var selectedID = $("label:contains('\n " + data.answer + "')").attr('for');
            if(selectedID) {
              $('#'+selectedID).prop('checked',true);
            }
          }
          else {
            if(question.progressive_info) {
              document.getElementById('stages-body').innerHTML = "";
              currentStage = data.currentStage;
              progressive_info = question.progressive_info;
              var stages = JSON.parse(progressive_info["stages"]);
              var step = parseFloat(progressive_info["step"]);
              var minPoints = parseFloat(progressive_info["min_points"]);
              var maxPoints = parseFloat(progressive_info["max_points"]);
              var currentMaxPoints = maxPoints - (step*currentStage);
              initialAppendToStagesTable(stages);
              displayNewMaxPoints(currentMaxPoints);
              document.getElementById('total-hints-counter').innerHTML = stages.length;
              document.getElementById('current-hints-counter').innerHTML = currentStage+1;
              document.getElementById('next-hint-text').innerHTML = "Next Hint (-" + progressive_info["step"] + " points)"

              document.getElementById('next-hint-paragraph').style.display = "block";
              document.getElementById('hints-caption').style.display = "table-caption";
              if(currentStage == (stages.length - 1)) {
                document.getElementById('next-hint').style.display = "none";
              }
              else {
                document.getElementById('next-hint').style.display = "inline-block";
              }
              document.getElementById('next-hint').addEventListener('click', function() {
                showNextHint(stages, step, minPoints);
              }, false);
            }
            document.getElementById('id_response').value = "";
            autosize(document.querySelectorAll('textarea'));
            $("#id_response").keypress(function (e) {
              if(e.which == 13 && !e.shiftKey) {
                e.preventDefault();
                handleForm();
              }
            });
            document.getElementById("form").addEventListener('submit', function(event){event.preventDefault();handleForm(event);})
            document.getElementById("set-answer").onclick = handleForm;
            document.getElementById("edit-answer").onclick = editAnswer;
          }
          answers.style.display = "none";
          form.style.display = "block";
          if(data.answer) {
            document.getElementById("current-answer-display").style.display="block";
          }
        }
        else {
          if(question.progressive_info) {
            document.getElementById('stages-body').innerHTML = "";
            progressive_info = question.progressive_info;
            var stages = JSON.parse(progressive_info["stages"]);
            currentStage = stages.length-1;
            initialAppendToStagesTable(stages);
            document.getElementById('next-hint-paragraph').style.display = "none";
            document.getElementById('hints-caption').style.display = "none";
          }
          form.style.display = "none";
          document.getElementById("answer-display").innerHTML = "";
          answers.style.display = "block";
        }
      };

      chatSocket.onmessage = function(e) {
        console.log(e)
        const data = JSON.parse(e.data);
        const command = data.command;
        if(onRoundStart && !command.includes("player")) {
          document.getElementById('page-row').style.backgroundImage = "";
          onRoundStart = false;
        }

        if(command === 'gameStart') {
          $("#current-screen").load("{% static 'quiz/gameStart.html' %}");
        }
        else if(command === 'quizStart') {
          if(data.quizTitle) {
            $("#current-screen").load("{% static 'quiz/quizStart.html' %}", function() {
              document.getElementById('quizTitle').innerHTML = data.quizTitle;
              document.getElementById('quizNumber').innerHTML = data.quizNumber;
              document.getElementById('quizDesc').innerHTML = data.quizDesc;
            });
          }
        }
        else if(command === 'quizEnd') {
          if(data.quizTitle) {
            $("#current-screen").load("{% static 'quiz/quizEnd.html' %}", function() {
              document.getElementById('quizTitle').innerHTML = data.quizTitle;
              document.getElementById('quizNumber').innerHTML = data.quizNumber;
              displayScores(data.scoresDict);
              quizResultsAnimation(data);
            });
          }
        }
        else if(command === 'roundStart') {
          if(data.roundTitle) {
            $("#current-screen").load("{% static 'quiz/roundStart.html' %}", function() {
              onRoundStart = true;
              document.getElementById('roundTitle').innerHTML = data.roundTitle;
              document.getElementById('roundNumber').innerHTML = data.roundNumber;
              document.getElementById('roundDesc').innerHTML = data.roundDesc;
              if(data.roundImg) {
                document.getElementById('round-container').style.background = "rgba(0, 0, 0, 0.75)";
                document.getElementById('page-row').style.backgroundImage = "url('" + data.roundImg + "')";
                fadeIn(document.getElementById('page-row'));
              }
              else {
                // document.getElementById('roundImg').style.display = "none";
              }
            });
          }
        }
        else if(command === 'roundTransition') {
          $("#current-screen").load("{% static 'quiz/roundTransition.html' %}");
        }
        else if(command === 'roundEnd') {
          if(data.roundTitle) {
            $("#current-screen").load("{% static 'quiz/roundEnd.html' %}", function() {
              document.getElementById('roundTitle').innerHTML = data.roundTitle;
              document.getElementById('roundNumber').innerHTML = data.roundNumber;
              document.getElementById('scores-display').innerHTML = data.scoresHTML;
              roundResultsAnimation();
            });
          }
        }
        else if (command === 'question') {
          question = data.question
          multiple_choice = !(question.multiple_choice_form == null)
          progressive = !(question.progressive_info == null)
          if(question.id) {
              if(multiple_choice) {
                $("#current-screen").load("{% static 'quiz/showMultipleChoiceQuestion.html' %}", function() {
                  loadQuestion(data);
                });
              }
              else if(progressive) {
                $("#current-screen").load("{% static 'quiz/showProgressiveQuestion.html' %}", function() {
                  loadQuestion(data);
                });
              }
              else {
                $("#current-screen").load("{% static 'quiz/showQuestion.html' %}", function() {
                  loadQuestion(data);
                });
              }
          }
        }
        else if (command === 'answer') {
          answer = data.answer;
          questionID = document.getElementById('question-id').value;
          if(answer.username == username && answer.questionID == questionID) {
            document.getElementById('current-answer').innerHTML = answer.answer;
            if(answer.answer) {
              document.getElementById("current-answer-display").style.display="block";
              document.getElementById('id_response').value = "";
              autosize.update(document.getElementById('id_response'));
            }
          }
        }
        else if (command === 'showAnswer') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            usernameElem = document.getElementById('answers-' + data.username);
            if(usernameElem === null) {
              document.getElementById('answer-display').innerHTML += data.answerHTML;
            }
            else {
              usernameElem.innerHTML = data.answerHTML;
            }
          }
        }
        else if (command === 'showAllAnswers') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            document.getElementById('answer-display').innerHTML = data.answersHTML;
          }
        }
        else if (command === 'correctAnswer') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            document.getElementById('correct-answer-display').style.display="block";
            document.getElementById('correct-answer').innerHTML = data.answer;
          }
        }
        else if (command === 'timer') {
          questionID = document.getElementById('question-id').value;
          if(questionID == data.questionID) {
            var timerEnd = new Date(Date.parse(new Date(data.timerEnd)));
            timeInterval = initializeClock('timerCountdown', timerEnd, data.timeRemaining, timeInterval);
          }
        }
        else if (command === 'playerList') {
          document.getElementById("player-list").innerHTML = data.playerList;
        }
        else if (command === 'playerConnect') {
          if(data.username !== username) {
            document.getElementById("player-list").innerHTML += "<p id='plist-" + data.username + "'>" + data.username + "</p>";
          }
        }
        else if (command === 'playerDisconnect') {
          var element = document.getElementById("plist-"+data.username);
          element.parentNode.removeChild(element);
        }
      };

      function handleForm(event) {
        var answer = document.getElementById('id_response').value;
        var questionID = document.getElementById('question-id').value;
        var maxPoints = null;
        var maxPointsElem = document.getElementById('current-max-points');
        if(maxPointsElem) {
          maxPoints = parseFloat(maxPointsElem.innerHTML);
        }
        chatSocket.sendMessage({ command: 'set_text_answer', questionID: questionID, gameID: roomCode, userID: userID, answer: answer, maxPoints: maxPoints });
      };

      function handleMultipleChoiceForm(event) {
        var answer = $("input[name=response]:checked").parent().text().trimLeft();
        console.log(answer);
        var questionID = document.getElementById('question-id').value;
        chatSocket.sendMessage({ command: 'set_text_answer', questionID: questionID, gameID: roomCode, userID: userID, answer: answer });
      };

      function editAnswer(event) {
        response = document.getElementById('id_response');
        response.value = document.getElementById('current-answer').innerHTML;
        autosize.update(response);
      };

      function showNextHint(stages, step, minPoints) {
        var newMax = parseFloat(document.getElementById('current-max-points').innerHTML) - step;
        if(Math.round(newMax) < minPoints) {
          console.log("Error, too low");
          return false;
        }
        currentStage++;
        console.log(currentStage);
        if(currentStage >= stages.length) {
          console.log("Gone past end of stage array.");
          return false;
        }
        var questionID = document.getElementById('question-id').value;
        chatSocket.sendMessage({ command: 'increment_user_progressive_stage', questionID: questionID, gameID: roomCode, userID: userID, currentStage: currentStage, maxPoints: newMax });

        displayNewMaxPoints(newMax);
        if(currentStage == (stages.length - 1)) {
          document.getElementById('next-hint').style.display = "none";
        }
        appendToStagesTable(stages);
        document.getElementById('current-hints-counter').innerHTML = currentStage+1;
      };

      function fadeIn(element) {
          element.style.opacity = 0;
          var tick = function () {
              element.style.opacity = +element.style.opacity + 0.0075;
              if (+element.style.opacity < 1) {
                  (window.requestAnimationFrame && requestAnimationFrame(tick)) || setTimeout(tick, 16)
              }
          };
          tick();
      };

      function roundResultsAnimation() {
        gsap.from(".score", {duration: 3, x: 300, opacity: 0, scale: 1, delay: 0.5,
          ease: "elastic",
          stagger: -1,
        });
      };

      function quizResultsAnimation() {
        var tl = gsap.timeline({onComplete: quizSwitchPodium});
        tl.from(".score", {duration: 3, x: 300, opacity: 0, scale: 1, delay: 0.5,
          ease: "elastic",
          stagger: -1,
        });
      };

      function quizSwitchPodium() {
        $('#carousel').on('slide.bs.carousel', function (event) {
          quizPodiumAnimation();
          $('#carousel').unbind('slide.bs.carousel');
        });
        $('#carousel').carousel(1);
      };

      function quizPodiumAnimation() {
        var tl = gsap.timeline({onComplete: endQuizAnimation});
        var delay = 1; //Ensures first thing shown has delay of 1, second has delay of 0.5.
        if(document.querySelector('#place-2 .podiumScore')) {
          tl.from("#place-2 .podiumScore", {duration: 3, x: 300, opacity: 0, scale: 1, delay: 1,
            ease: "elastic",
          });
          delay=0.5;
        }
        if(document.querySelector('#place-1 .podiumScore')) {
          tl.from("#place-1 .podiumScore", {duration: 3, x: 300, opacity: 0, scale: 1, delay: delay,
            ease: "elastic",
          });
          delay=0;
        }
        if(document.querySelector('#place-0 .podiumScore')) {
          tl.from("#place-0 .podiumScore", {duration: 3, x: 300, opacity: 0, scale: 1, delay: delay,
            ease: "elastic",
          });
        }
      };

      function endQuizAnimation() {
        document.getElementById("carousel-left").style.display="flex";
        document.getElementById("carousel-right").style.display="flex";
      };

      function scoreToString(rank, score) {
        str = "";
        if(rank < 3) {
          str = "<span class='podiumScore'>" + score.username + "<br>" + score.score + " points</span>";
        }
        else {
          rank++;
          str = "<div class='score'><b>" + rank + "</b><br>" + score.username + "<br>" + score.score + " points</div>";
        }
        return str;
      };

      function displayScores(scores) {
        console.log(scores);
        for(var i = 0; i < 3 && i < scores.length; i++) {
          document.getElementById('place-'+i).innerHTML = scoreToString(i, scores[i]);
        }
        table = document.getElementById('scores-display');
        for(var i = 3; i < scores.length; i++) {
            var row = table.insertRow(-1);
            var cell = row.insertCell(-1);
            cell.innerHTML = scoreToString(i, scores[i]);
        }
      };

      function initialAppendToStagesTable(stages) {
        for(var i = 0; i <= currentStage; i++) {
          table = document.getElementById('stages-body');
          var row = table.insertRow(-1);
          var cell1 = row.insertCell(-1);
          var cell2 = row.insertCell(-1);
          cell1.innerHTML = i+1;
          cell1.className = "fit";
          cell2.innerHTML = stages[i]["fields"]["text"];
        }
      };

      function appendToStagesTable(stages) {
        table = document.getElementById('stages-body');
        var row = table.insertRow(-1);
        var cell1 = row.insertCell(-1);
        var cell2 = row.insertCell(-1);
        cell1.innerHTML = currentStage+1;
        cell1.className = "fit";
        cell2.innerHTML = stages[currentStage]["fields"]["text"];
      };

      function displayNewMaxPoints(newMax) {
        var newMaxFormatted;
        if(newMax % 1 == 0) {
          newMaxFormatted = +newMax.toFixed(2);
        }
        else {
          newMaxFormatted = newMax.toFixed(2);
        }
        document.getElementById('current-max-points').innerHTML = newMaxFormatted;
      };
});
</script>

{% endif %}
{% endblock %}
